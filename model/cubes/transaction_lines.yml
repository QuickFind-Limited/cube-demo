cubes:
- name: transaction_lines
  sql: "SELECT\n  tl.*,\n  t.type as transaction_type,\n  t.currency as transaction_currency,\n\
    \  t.trandate as transaction_date,\n  t.status as transaction_status,\n  t.subsidiary\
    \ as transaction_subsidiary,\n  t.custbody_customer_email as customer_email,\n\
    \  t.billing_country,\n  t.shipping_country,\n  l.name as location_name,\n  --\
    \ P5 FIX: Removed inline CASE statement - now using locations.channel_type via\
    \ join\n  i.itemid as sku,\n  i.displayname as product_name,\n  i.custitem_gpc_category\
    \ as category,\n  i.custitem_gpc_sections as section,\n  i.custitem_gpc_season\
    \ as season,\n  i.custitem_gpc_size as size,\n  i.custitem_gpc_range as product_range,\n\
    \  i.custitem_gpc_collection as collection,\n  i.custitem_gpc_child_colour as\
    \ color,\n  i.baseprice as item_base_price,\n  t.exchangerate as transaction_exchange_rate,\n\
    \  curr.name as currency_name,\n  d.name as department_name,\n  c.name as classification_name\n\
    FROM demo.transaction_lines_clean tl LEFT JOIN demo.transactions_analysis t ON\
    \ tl.transaction = t.id LEFT JOIN demo.currencies curr ON t.currency = curr.id\
    \ LEFT JOIN demo.locations l ON tl.location = l.id LEFT JOIN demo.items i ON tl.item\
    \ = i.id LEFT JOIN demo.departments d ON tl.department = d.id LEFT JOIN demo.classifications\
    \ c ON tl.class = c.id WHERE tl.item != 25442\n"
  title: Transaction Lines
  description: Line items from all transactions - the main fact table for metrics
    (denormalized)
  joins:
  - name: transactions
    relationship: many_to_one
    sql: '{CUBE}.transaction = {transactions.id}'
  - name: inventory
    relationship: many_to_one
    sql: '{CUBE}.item = {inventory.item}'
  - name: locations
    relationship: many_to_one
    sql: '{CUBE}.location_name = {locations.name}'
  measures:
  - name: total_revenue
    sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN\n\
      \  ({CUBE}.amount * -1 * COALESCE({CUBE}.transaction_exchange_rate, 1.0))\n\
      ELSE 0 END AS FLOAT64)\n"
    type: sum
    format: currency
    description: Total gross revenue in EUR (CustInvc + CashSale only, all currencies
      converted using transaction-date exchange rates)
  - name: net_revenue
    sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN\n\
      \  (({CUBE}.amount * -1) - COALESCE({CUBE}.taxamount, 0)) * COALESCE({CUBE}.transaction_exchange_rate,\
      \ 1.0)\nELSE 0 END AS FLOAT64)\n"
    type: sum
    format: currency
    description: Net revenue in EUR (gross revenue minus tax, all currencies converted
      using transaction-date exchange rates)
  - name: units_sold
    sql: CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.quantity
      < 0 THEN {CUBE}.quantity * -1 ELSE 0 END AS FLOAT64)
    type: sum
    description: Total units sold (uses CASE per Rule 2, CustInvc + CashSale only
      to match total_revenue filter)
  - name: units_returned
    sql: CAST(CASE WHEN {CUBE}.quantity > 0 THEN {CUBE}.quantity ELSE 0 END AS FLOAT64)
    type: sum
    description: Total units returned
  - name: total_tax
    sql: CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN {CUBE}.taxamount
      ELSE 0 END AS FLOAT64)
    type: sum
    format: currency
    description: Total tax amount (CustInvc + CashSale only)
  - name: total_discount
    sql: CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price
      > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ({CUBE}.item_base_price - {CUBE}.rate)
      * ABS({CUBE}.quantity) ELSE 0 END AS FLOAT64)
    type: sum
    format: currency
    description: Total discount amount (baseprice - rate) for DM001
  - name: total_discount_amount
    sql: CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price
      > 0 AND {CUBE}.quantity < 0 THEN ({CUBE}.item_base_price - {CUBE}.rate) * ABS({CUBE}.quantity)
      ELSE 0 END
    type: sum
    format: currency
    description: Total discount amount for discount_rate calculation (additive component
      for DM002)
  - name: total_base_price_for_discount
    sql: CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.quantity
      < 0 THEN {CUBE}.item_base_price * ABS({CUBE}.quantity) ELSE 0 END
    type: sum
    format: currency
    description: Total base price for discount_rate calculation (additive component
      for DM002)
  - name: discount_rate
    sql: 100.0 * {total_discount_amount} / NULLIF({total_base_price_for_discount},
      0)
    type: number
    description: Average discount rate percentage for DM002 (calculated from components
      - NOT for use in pre-aggs)
  - name: discounted_units
    sql: CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') AND {CUBE}.item_base_price
      > {CUBE}.rate AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END AS
      FLOAT64)
    type: sum
    description: Units sold at discount for DM058
  - name: line_count
    type: count
    description: Total number of line items
  - name: transaction_count
    sql: '{CUBE}.transaction'
    type: count_distinct_approx
    description: Number of unique transactions (approximate - 10-20% error possible
      due to HyperLogLog rollup). For exact counts, use transaction_count_exact with
      limited dimensions.
  - name: sku_count
    sql: '{CUBE}.item'
    type: count_distinct_approx
    description: Number of unique SKUs
  - name: average_order_value
    sql: 1.0 * {total_revenue} / NULLIF({transaction_count}, 0)
    type: number
    format: currency
    description: Average order value (AOV) - revenue transactions only (approximate
      - uses count_distinct_approx). For exact AOV, use average_order_value_exact
      with limited dimensions.
  - name: salesord_revenue
    sql: CAST(CASE WHEN {CUBE}.transaction_type = 'SalesOrd' THEN {CUBE}.amount *
      -1 ELSE 0 END AS FLOAT64)
    type: sum
    format: currency
    description: Total revenue from SalesOrd transactions only (component for OM003)
  - name: salesord_count
    sql: '{CUBE}.transaction'
    type: count_distinct_approx
    filters:
    - sql: '{CUBE}.transaction_type = ''SalesOrd'''
    description: Count of unique SalesOrd transactions (approximate - 10-20% error
      possible due to HyperLogLog rollup). For exact counts, use salesord_count_exact
      with limited dimensions.
  - name: average_salesord_value
    sql: 1.0 * SUM(CASE WHEN {CUBE}.transaction_type = 'SalesOrd' THEN {CUBE}.amount
      * -1 ELSE 0 END) / NULLIF(COUNT(DISTINCT CASE WHEN {CUBE}.transaction_type =
      'SalesOrd' THEN {CUBE}.transaction END), 0)
    type: number
    format: currency
    description: Average order value from SalesOrd (OM003 - calculated measure, not
      in pre-agg)
  - name: average_items_per_order
    sql: 1.0 * {line_count} / NULLIF({transaction_count}, 0)
    type: number
    description: Average number of items per order
  - name: average_selling_price
    sql: 1.0 * {total_revenue} / NULLIF({units_sold}, 0)
    type: number
    format: currency
    description: Average selling price per unit
  - name: total_cost
    sql: CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN {CUBE}.costestimate
      * {CUBE}.quantity ELSE 0 END AS FLOAT64)
    type: sum
    format: currency
    description: "Total cost estimate (costestimate \xD7 quantity, both negative for\
      \ sales = positive total cost)"
  - name: gross_margin
    sql: "CAST(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale') THEN\n\
      \  (({CUBE}.amount * -1) - (COALESCE({CUBE}.costestimate, 0) * {CUBE}.quantity))\
      \ * COALESCE({CUBE}.transaction_exchange_rate, 1.0)\nELSE 0 END AS FLOAT64)\n"
    type: sum
    format: currency
    description: Gross margin in EUR (revenue - cost, all currencies converted using
      transaction-date exchange rates)
  - name: gross_margin_percent
    sql: 100.0 * (({total_revenue}) - ({total_cost})) / NULLIF({total_revenue}, 0)
    type: number
    description: Gross margin percentage
  - name: gross_profit
    sql: '{gross_margin}'
    type: number
    format: currency
    description: Gross Profit (alias for gross_margin) - Revenue minus COGS. Same
      as gross_margin measure, provided for clarity in AI queries.
  - name: gmroi_numerator
    sql: '{gross_margin}'
    type: number
    format: currency
    description: GMROI numerator component - use gross_margin for specified time period
      (e.g., YTD). Divide by inventory.inventory_value_at_cost to get GMROI ratio.
  - name: total_landed_costs
    sql: CAST(CASE WHEN {CUBE}.transaction_type = 'ItemRcpt' AND {CUBE}.blandedcost
      = TRUE THEN {CUBE}.amount ELSE 0 END AS FLOAT64)
    type: sum
    format: currency
    description: Total landed costs (freight + duties) from Item Receipts. Uses blandedcost=TRUE
      flag. LAND001 metric.
  - name: itemrcpt_line_count
    type: count
    filters:
    - sql: '{CUBE}.transaction_type = ''ItemRcpt'''
    description: Count of Item Receipt lines (inventory + landed costs)
  - name: total_itemrcpt_amount
    sql: CAST(CASE WHEN {CUBE}.transaction_type = 'ItemRcpt' THEN {CUBE}.amount ELSE
      0 END AS FLOAT64)
    type: sum
    format: currency
    description: Total Item Receipt amounts (inventory value + landed costs combined)
  - name: avg_landed_cost_per_receipt
    sql: '{total_landed_costs} / NULLIF({itemrcpt_line_count}, 0)'
    type: number
    format: currency
    description: Average landed cost per Item Receipt line
  - name: min_transaction_date
    sql: '{CUBE}.transaction_date'
    type: min
    description: Earliest transaction date in result set
  - name: max_transaction_date
    sql: '{CUBE}.transaction_date'
    type: max
    description: Latest transaction date in result set
  - name: units_per_week
    sql: "1.0 * SUM(CASE WHEN {CUBE}.transaction_type IN ('CustInvc', 'CashSale')\
      \ AND {CUBE}.quantity < 0 THEN ABS({CUBE}.quantity) ELSE 0 END) / NULLIF(\n\
      \  (MAX(CAST({CUBE}.transaction_date AS DATE)) - MIN(CAST({CUBE}.transaction_date\
      \ AS DATE))) / 7.0 + 1,\n  0\n)\n"
    type: number
    description: Sales velocity - units sold per week (LIFE004)
  - name: return_rate
    sql: 100.0 * {units_returned} / NULLIF({units_sold} + {units_returned}, 0)
    type: number
    description: Return rate percentage (RET001)
  dimensions:
  - name: id
    sql: '{CUBE}.id'
    type: number
    primary_key: true
  - name: transaction
    sql: '{CUBE}.transaction'
    type: number
  - name: item
    sql: '{CUBE}.item'
    type: number
  - name: location
    sql: '{CUBE}.location'
    type: number
  - name: quantity
    sql: '{CUBE}.quantity'
    type: number
  - name: amount
    sql: '{CUBE}.amount'
    type: number
  - name: rate
    sql: '{CUBE}.rate'
    type: number
    description: Unit rate
  - name: costestimate
    sql: '{CUBE}.costestimate'
    type: number
    description: Cost estimate for margin calculations
  - name: mainline
    sql: '{CUBE}.mainline'
    type: string
    description: 'Mainline flag: T for header, F for detail lines'
  - name: class
    sql: '{CUBE}.class'
    type: number
    description: Classification ID
  - name: department
    sql: '{CUBE}.department'
    type: number
  - name: transaction_type
    sql: '{CUBE}.transaction_type'
    type: string
    description: 'Transaction type: SalesOrd, CustInvc, CashSale'
  - name: transaction_currency
    sql: '{CUBE}.transaction_currency'
    type: number
    description: Transaction currency ID (denormalized from transactions table)
  - name: currency_name
    sql: '{CUBE}.currency_name'
    type: string
    description: Currency code (EUR, GBP, USD, AUD, etc.) - use this for currency
      breakdowns
  - name: transaction_date
    sql: TIMESTAMP(PARSE_DATE('%d/%m/%Y', {CUBE}.transaction_date))
    type: time
    description: 'Transaction date - PARAMETERIZED: Use timeDimensions with dateRange
      (default: ''last 12 months'')'
  - name: month
    sql: TIMESTAMP_TRUNC({transaction_lines.transaction_date}, MONTH)
    type: time
    description: Transaction month
  - name: quarter
    sql: TIMESTAMP_TRUNC({transaction_lines.transaction_date}, QUARTER)
    type: time
    description: Transaction quarter
  - name: year
    sql: TIMESTAMP_TRUNC({transaction_lines.transaction_date}, YEAR)
    type: time
    description: Transaction year
  - name: week
    sql: TIMESTAMP_TRUNC({transaction_lines.transaction_date}, WEEK)
    type: time
    description: Transaction week
  - name: customer_email
    sql: '{CUBE}.customer_email'
    type: string
    description: Customer email address
  - name: billing_country
    sql: '{CUBE}.billing_country'
    type: string
    description: Billing country
  - name: shipping_country
    sql: '{CUBE}.shipping_country'
    type: string
    description: Shipping country
  - name: location_name
    sql: '{CUBE}.location_name'
    type: string
    description: Location name
  - name: channel_type
    sql: >
      CASE
        WHEN {CUBE}.department = 109 THEN 'D2C'
        WHEN {CUBE}.department = 108 THEN 'RETAIL'
        WHEN {CUBE}.department = 207 THEN 'B2B_MARKETPLACE'
        WHEN {CUBE}.department = 206 THEN 'B2B_WHOLESALE'
        WHEN {CUBE}.department_name LIKE '%Wholesale%' THEN 'B2B_WHOLESALE'
        WHEN {CUBE}.department_name LIKE '%Event%' THEN 'EVENTS'
        ELSE 'OTHER'
      END
    type: string
    description: 'Channel type based on department field (SKILL v62 fix): D2C (dept 109), RETAIL (dept 108), B2B_MARKETPLACE (dept 207), B2B_WHOLESALE (dept 206)'
  - name: sku
    sql: '{CUBE}.sku'
    type: string
    description: Item SKU code
  - name: product_name
    sql: '{CUBE}.product_name'
    type: string
    description: Product display name
  - name: category
    sql: '{CUBE}.category'
    type: string
    description: Product category
  - name: section
    sql: '{CUBE}.section'
    type: string
    description: Product section (e.g., Hoodies, Fleeces, Sweatshirts, Leggings)
  - name: season
    sql: '{CUBE}.season'
    type: string
    description: Product season (e.g., AW25, SS24)
  - name: size
    sql: '{CUBE}.size'
    type: string
    description: Product size
  - name: product_range
    sql: '{CUBE}.product_range'
    type: string
    description: Product range
  - name: collection
    sql: '{CUBE}.collection'
    type: string
    description: Product collection
  - name: color
    sql: '{CUBE}.color'
    type: string
    description: Product color
  - name: department_name
    sql: '{CUBE}.department_name'
    type: string
    description: Department name
  - name: classification_name
    sql: '{CUBE}.classification_name'
    type: string
    description: Classification name
  - name: pricing_type
    sql: "CASE\n  WHEN {CUBE}.item_base_price > {CUBE}.rate THEN 'RP'\n  ELSE 'FP'\n\
      END\n"
    type: string
    description: 'Pricing type: FP (Full Price) when no discount, RP (Reduced Price)
      when item sold below base price'
  - name: customer_type
    sql: '{transactions.customer_type}'
    type: string
    title: Customer Type
    description: 'Customer segmentation based on email presence: Retail/D2C customers
      have email addresses (individual consumers, ~66% of transactions), B2B/Wholesale
      customers do not (POS systems, wholesale accounts, corporate buyers, ~34% of
      transactions). CRITICAL for pricing analysis - ALWAYS segment by this dimension
      when analyzing pricing, discounts, margins, or AOV to avoid mixing two fundamentally
      different business models. B2B customers pay 10-30% of retail (wholesale bulk
      pricing), Retail/D2C customers pay 70-100% of retail (normal pricing). Note:
      customer_type = WHO bought, channel_type = WHERE they bought.'
  - name: landedcostperline
    sql: '{CUBE}.landedcostperline'
    type: boolean
    description: Landed cost line flag from NetSuite (always TRUE for ItemRcpt transactions)
  - name: blandedcost
    sql: '{CUBE}.blandedcost'
    type: boolean
    description: 'ACTUAL landed cost indicator: TRUE = freight/duty line, FALSE =
      inventory receipt line. Use for LAND001 metric.'
  - name: estgrossprofit
    sql: CAST({CUBE}.estgrossprofit AS FLOAT64)
    type: number
    description: Estimated gross profit from NetSuite (for ItemRcpt lines)
  - name: estgrossprofitpercent
    sql: CAST({CUBE}.estgrossprofitpercent AS FLOAT64)
    type: number
    description: Estimated gross profit percentage from NetSuite
  - name: foreignamount
    sql: CAST({CUBE}.foreignamount AS FLOAT64)
    type: number
    description: Amount in foreign currency before conversion (ItemRcpt lines)
  - name: quantitybilled
    sql: CAST({CUBE}.quantitybilled AS INT64)
    type: number
    description: Quantity billed on this line (ItemRcpt tracking)
  - name: quantitypacked
    sql: CAST({CUBE}.quantitypacked AS INT64)
    type: number
    description: Quantity packed/fulfilled on this line (ItemRcpt tracking)
  - name: subsidiary
    sql: CAST({CUBE}.subsidiary AS INT64)
    type: number
    description: Subsidiary ID (denormalized from transaction_lines for ItemRcpt analysis)
  segments:
  - name: sales_lines
    sql: '{CUBE}.quantity < 0'
  - name: return_lines
    sql: '{CUBE}.quantity > 0'
  - name: revenue_transactions
    sql: '{CUBE}.transaction_type IN (''CustInvc'', ''CashSale'')'
  pre_aggregations:
  # Revenue-only pre-aggregation
  - name: revenue_analysis
    scheduled_refresh: false
    measures:
    - total_revenue
    - net_revenue
    - units_sold
    - units_returned
    - total_tax
    - line_count
    - transaction_count
    - total_discount_amount
    - total_base_price_for_discount
    - salesord_revenue
    - salesord_count
    - min_transaction_date
    - max_transaction_date
    dimensions:
    - channel_type
    - category
    - section
    - season
    - product_range
    - collection
    - department_name
    - billing_country
    - shipping_country
    - classification_name
    - transaction_currency
    - currency_name
    - transaction_type
    - pricing_type
    - sku
    - product_name
    - size
    - color
    - location_name
    - customer_type
    time_dimension: transaction_date
    granularity: day
    partition_granularity: week
    build_range_end:
      sql: SELECT '2025-10-31'
    indexes:
    - name: channel_category_idx
      columns:
      - channel_type
      - category
    refresh_key:
      every: 365 days
